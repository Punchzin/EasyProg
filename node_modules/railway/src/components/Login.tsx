import { Box, Text } from "ink";
import Link from "ink-link";
import React, { useMemo } from "react";
import { getAndSaveAuth, getRandomCode } from "../auth";
import { loginWebpage } from "../config";
import { useAsyncAction } from "../hooks/useAsyncAction";
import { useExitDelay } from "../hooks/useExitDelay";
import { User } from "../types";
import { Spinner } from "./Spinner";

export const Login: React.FC<{ port: number }> = ({ port }) => {
  const exit = useExitDelay();

  const code = useMemo(() => getRandomCode(), []);
  const loginUrl = loginWebpage(port, code);

  const status = useAsyncAction<User>(
    async () => {
      const user = await getAndSaveAuth(port, code);
      return user;
    },
    exit,
    [],
  );

  return (
    <Box>
      {status.loading ? (
        <Box flexDirection="column">
          <Text>
            <Spinner /> Logging in. You will be redirected to ðŸ‘‡
          </Text>

          <Box paddingLeft={2}>
            <Link url={loginUrl}>
              <Text>{loginUrl}</Text>
            </Link>
          </Box>
        </Box>
      ) : status.error != null ? (
        <Text>Oops, Something went wrong :(</Text>
      ) : (
        <Text>
          ðŸŽ‰ Logged in as{" "}
          <Text color="blue">
            {status.data.name ?? status.data.email}

            {status.data.name != null && <> ({status.data.email})</>}
          </Text>
        </Text>
      )}
    </Box>
  );
};
