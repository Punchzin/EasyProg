import React, { useState, useEffect } from "react";
import { useApp, Text } from "ink";
import { getConfig, railwayUrl } from "../config";
import { delay } from "../utils";
import { Spinner } from "./Spinner";
import open from "open";
import Link from "ink-link";
import { getProject } from "../api";

export const Open: React.FC = () => {
  const [url, setUrl] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const { exit } = useApp();

  useEffect(() => {
    (async () => {
      try {
        const config = getConfig();

        if (config.project == null) {
          throw new Error("`project` required in .railway/config.json");
        }

        const project = await getProject(config.project);

        const url =
          project.plugins.length > 0
            ? `${railwayUrl}/project/${project.id}/plugin/${project.plugins[0].name}`
            : `${railwayUrl}/project/${project.id}/settings`;

        setUrl(url);
        open(url);

        await delay(10);
        exit();
      } catch (e) {
        setError(e.message);

        await delay(10);
        exit();
      }
    })();
  }, []);

  if (error != null) {
    return <Text color="red">{error}</Text>;
  }

  return (
    <Text>
      {url == null ? (
        <Text>
          <Spinner /> Opening...
        </Text>
      ) : (
        <Text>
          Opening{" "}
          <Link url={url}>
            <Text color="blue">{url}</Text>
          </Link>
        </Text>
      )}
    </Text>
  );
};
