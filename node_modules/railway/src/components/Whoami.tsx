import { Box, Text } from "ink";
import React from "react";
import { useAsyncAction } from "../hooks/useAsyncAction";
import { useExitDelay } from "../hooks/useExitDelay";
import { User } from "../types";
import { Spinner } from "./Spinner";
import { getUser } from "../api";

export const Whoami: React.FC = () => {
  const exit = useExitDelay();

  const status = useAsyncAction<User>(
    async () => {
      const user = await getUser();
      return user;
    },
    exit,
    [],
  );

  return (
    <Box>
      {status.loading ? (
        <Box>
          <Spinner />
        </Box>
      ) : status.error != null ? (
        <Text>
          Not logged in. Run <Text color="blue">railway login</Text> to login
        </Text>
      ) : (
        <Text>
          ðŸŽ‰ Logged in as{" "}
          <Text color="blue">
            {status.data.name ?? status.data.email}

            {status.data.name != null && <> ({status.data.email})</>}
          </Text>
        </Text>
      )}
    </Box>
  );
};
