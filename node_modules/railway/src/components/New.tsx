import { Box, Text, useApp } from "ink";
import React, { useState } from "react";
import { createProject } from "../api";
import { createConfig } from "../config";
import { delay } from "../utils";
import { Spinner } from "./Spinner";
import TextInput from "ink-text-input";

export const New: React.FC<{ force?: boolean }> = ({ force }) => {
  const [name, setName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [created, setCreated] = useState(false);
  const { exit } = useApp();

  const onSubmit = async () => {
    if (name.trim() === "") {
      setError("name cannot be empty");
      return;
    }

    try {
      setLoading(true);
      const project = await createProject(name);
      createConfig(project.id, project.environments[0]?.id, force);
      setCreated(true);

      await delay(10);
      exit();
    } catch (e) {
      setError(e.message);

      await delay(10);
      exit();
    }
  };

  if (error != null) {
    return <Text color="red">{error}</Text>;
  }

  if (created) {
    return (
      <Box>
        <Text>ðŸ’« Created project {name}</Text>
      </Box>
    );
  }

  return (
    <Box>
      {loading ? (
        <Text>
          <Spinner /> Loading...
        </Text>
      ) : (
        <>
          <Box marginRight={1}>
            <Text>Enter project name:</Text>
          </Box>

          <TextInput value={name} onChange={setName} onSubmit={onSubmit} />
        </>
      )}
    </Box>
  );
};
