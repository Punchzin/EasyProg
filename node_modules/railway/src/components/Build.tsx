import { Box, Newline, Text } from "ink";
import React from "react";
import { paths, railwayProductionToken } from "../config";
import { saveEnvToFile } from "../env";
import { useAsyncAction } from "../hooks/useAsyncAction";
import { useExitDelay } from "../hooks/useExitDelay";
import { Spinner } from "./Spinner";

export const Build: React.FC = () => {
  const exit = useExitDelay();

  const status = useAsyncAction<boolean>(
    async () => {
      if (railwayProductionToken != null) {
        await saveEnvToFile();
        return true;
      } else {
        return false;
      }
    },
    exit,
    [],
  );

  return (
    <Box>
      {status.loading ? (
        <Box>
          <Spinner />
        </Box>
      ) : status.error != null ? (
        <Text color="red">{status.error}</Text>
      ) : status.data ? (
        <Text>
          Env written to {paths.railwayEnvFilePath} <Newline />
          Do NOT commit the env.json file. This command should only be run as a
          production build step.
        </Text>
      ) : (
        <Text color="yellow">
          Railway env file only generated in production
        </Text>
      )}
    </Box>
  );
};
